<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">
    
    <changeSet id="ADD_COLUMN_ENVIRONMENT_ID_TO_TEST_DATA_TABLE_CATALOG" author="admin">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="TEST_DATA_TABLE_CATALOG" columnName="ENVIRONMENT_ID"/>
            </not>
        </preConditions>
        <addColumn tableName="TEST_DATA_TABLE_CATALOG">
            
            <column name="ENVIRONMENT_ID" type="uuid">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>
    
    <changeSet id="ADD_COLUMN_CLEANUP_TYPE_TO_TEST_DATA_CLEANUP_CONFIG" author="admin">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="TEST_DATA_CLEANUP_CONFIG" columnName="TYPE"/>
            </not>
        </preConditions>
        <addColumn tableName="TEST_DATA_CLEANUP_CONFIG">
            <column name="TYPE" type="VARCHAR" defaultValue="SQL">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>
    
    <changeSet id="ADD_COLUMN_SEARCH_DATE_TO_TEST_DATA_CLEANUP_CONFIG" author="admin">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="TEST_DATA_CLEANUP_CONFIG" columnName="SEARCH_DATE"/>
            </not>
        </preConditions>
        <addColumn tableName="TEST_DATA_CLEANUP_CONFIG">
            <column name="SEARCH_DATE" type="VARCHAR">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="ADD_COLUMN_CREATED_WHEN_TO_TEST_DATA_OCCUPY_STATISTIC" author="admin">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="TEST_DATA_OCCUPY_STATISTIC" columnName="CREATED_WHEN"/>
            </not>
        </preConditions>
        <addColumn tableName="TEST_DATA_OCCUPY_STATISTIC">
            <column name="CREATED_WHEN" type="DATE" defaultValue="2010-01-01">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="ADD_COLUMN_UPDATE_BY_QUERY_TO_TEST_DATA_TABLE_IMPORT_INFO" author="admin">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="TEST_DATA_TABLE_IMPORT_INFO" columnName="UPDATE_BY_QUERY"/>
            </not>
        </preConditions>
        <addColumn tableName="TEST_DATA_TABLE_IMPORT_INFO">
            <column name="UPDATE_BY_QUERY" type="VARCHAR">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="DROP_CONSTRAIN_NOT_NULL_FOR_COLUMN_TABLE_QUERY_TO_TEST_DATA_TABLE_IMPORT_INFO" author="admin">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">
                SELECT CASE WHEN EXISTS (
                    SELECT 1
                    FROM information_schema.columns
                    WHERE table_name = 'test_data_table_import_info'
                      AND column_name = 'table_query'
                      AND is_nullable = 'NO'
                ) THEN 1 ELSE 0 END
            </sqlCheck>
        </preConditions>
        <dropNotNullConstraint tableName="TEST_DATA_TABLE_IMPORT_INFO" columnName="TABLE_QUERY"/>
    </changeSet>

    <changeSet id="ADD_COLUMN_QUERY_TIMEOUT_TO_TEST_DATA_TABLE_IMPORT_INFO" author="admin">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="TEST_DATA_TABLE_IMPORT_INFO" columnName="QUERY_TIMEOUT"/>
            </not>
        </preConditions>
        <addColumn tableName="TEST_DATA_TABLE_IMPORT_INFO">
            <column name="QUERY_TIMEOUT" type="INTEGER">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="ADD_COLUMN_QUERY_TIMEOUT_TO_TEST_DATA_CLEANUP_CONFIG" author="admin">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="TEST_DATA_CLEANUP_CONFIG" columnName="QUERY_TIMEOUT"/>
            </not>
        </preConditions>
        <addColumn tableName="TEST_DATA_CLEANUP_CONFIG">
            <column name="QUERY_TIMEOUT" type="INTEGER">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="ADD_COLUMN_ALL_ENV_TO_TEST_DATA_REFRESH_CONFIG" author="admin">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="TEST_DATA_REFRESH_CONFIG" columnName="ALL_ENV"/>
            </not>
        </preConditions>
        <addColumn tableName="TEST_DATA_REFRESH_CONFIG">
            <column name="ALL_ENV" type="BOOLEAN" defaultValue="false">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="DELETE_COLUMN_NOT_NULL_CONSTRAINT_OCCUPIED_BY_IN_TEST_DATA_OCCUPY_STATISTIC" author="admin">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">
                SELECT CASE WHEN EXISTS (
                    SELECT 1
                    FROM information_schema.columns
                    WHERE table_name = 'test_data_occupy_statistic'
                      AND column_name = 'occupied_by'
                      AND is_nullable = 'NO'
                ) THEN 1 ELSE 0 END
            </sqlCheck>
        </preConditions>
        <dropNotNullConstraint columnName="OCCUPIED_BY"
                               tableName="TEST_DATA_OCCUPY_STATISTIC"/>
    </changeSet>
    
    <changeSet id="DELETE_COLUMN_NOT_NULL_CONSTRAINT_OCCUPIED_DATE_IN_TEST_DATA_OCCUPY_STATISTIC" author="admin">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">
                SELECT CASE WHEN EXISTS (
                    SELECT 1
                    FROM information_schema.columns
                    WHERE table_name = 'test_data_occupy_statistic'
                      AND column_name = 'occupied_date'
                      AND is_nullable = 'NO'
                ) THEN 1 ELSE 0 END
            </sqlCheck>
        </preConditions>
        <dropNotNullConstraint columnName="OCCUPIED_DATE"
                               tableName="TEST_DATA_OCCUPY_STATISTIC"/>
    </changeSet>

    <changeSet id="DROP_TABLE_TEST_DATA_CLEANUP_STATISTIC" author="admin">
        <sqlFile path="migrationScripts/DROP_TABLE_TEST_DATA_CLEANUP_STATISTIC.sql" splitStatements="false"/>
    </changeSet>

    <changeSet id="MIGRATE_DATA_TO_PROJECT_INFORMATION_TABLE" author="admin">
        <sqlFile path="migrationScripts/MIGRATE_DATA_TO_PROJECT_INFORMATION.sql" splitStatements="false"/>
    </changeSet>

    <changeSet id="TEST_DATA_TABLE_CATALOG(PROJECT_ID, SYSTEM_ID)" author="admin">
        <preConditions onFail="MARK_RAN">
            <not>
                <indexExists indexName="TEST_DATA_TABLE_CATALOG(PROJECT_ID, SYSTEM_ID)"/>
            </not>
        </preConditions>
        <createIndex tableName="TEST_DATA_TABLE_CATALOG" indexName="TEST_DATA_TABLE_CATALOG(PROJECT_ID, SYSTEM_ID)">
            <column name="PROJECT_ID"/>
            <column name="SYSTEM_ID"/>
        </createIndex>
    </changeSet>

    <changeSet id="ADD_COLUMN_LAST_USAGE_TO_TEST_DATA_TABLE_CATALOG" author="admin">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="TEST_DATA_TABLE_CATALOG" columnName="LAST_USAGE"/>
            </not>
        </preConditions>
        <addColumn tableName="test_data_table_catalog">
            <column name="last_usage" type="DATE" defaultValueComputed="CURRENT_DATE"/>
        </addColumn>
    </changeSet>

    <changeSet id="ADD_COLUMN_EXPIRATION_MONTHS_TIMEOUT_TO_PROJECT_INFORMATION_TABLE" author="admin">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="PROJECT_INFORMATION" columnName="EXPIRATION_MONTHS_TIMEOUT"/>
            </not>
        </preConditions>
        <addColumn tableName="project_information">
            <column name="expiration_months_timeout" type="INTEGER" defaultValue="1" />
        </addColumn>
    </changeSet>

    <include file="v2/service-entities-migration.xml" relativeToChangelogFile="true"/>

</databaseChangeLog>
